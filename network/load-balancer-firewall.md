# 로드 밸런서/방화벽 (세션 장비)

## 4계층 장비의 특징

4계층 장비는 TCP와 같은 4계층 헤더에 있는 정보를 이해하고 이 정보들을 기반으로 동작합니다. 기존 네트워크 장비와 다른 점을 이해해야 하는데 세션 테이블과 그 안에서 관리하는 세션 정보가 가장 중요합니다. 그래서 4계층 이상에서 동작하는 로드 밸런서, 방화벽과 같은 장비를 '세션 장비'라고 부르기도 합니다.

세션 장비는 추가로 고려해야 할 특징이 많은데 그 중 최우선적으로 고려할 요소는 다음과 같습니다.

- 세션 테이블
  - 세션 장비는 세션 테이블 기반으로 운영됩니다.
  - 세션 정보를 저장, 확인하는 작업 전반에 대한 이해가 필요합니다.
  - 세션 정보는 세션 테이블에 남아 있는 라이프타임이 존재합니다. 이 부분에 대한 고려가 필요합니다.
- Symmetric 경로 요구
  - Inbound와 Outbound 경로가 일치해야 합니다.
- 정보 변경(로드 밸런서의 경우)
  - IP 주소가 변경되며 확장된 L7 로드 밸런서(ADC)는 애플리케이션 프로토콜 정보도 변경됩니다.

세션 장비의 이런 요소가 서비스에 영향을 미치므로 네트워크 통신 중간 위치에 세션을 기반으로 동작하는 방화벽, NAT, 로드 밸런서와 같은 장비가 있을 경우, 네트워크 인프라뿐만 아니라 시스템 설계와 애플리케이션 개발에도 세션 장비에 대한 고려가 필요합니다.

## 로드 밸런서

서버나 장비의 부하를 분산하기 위해 사용하는 장비를 흔히 로드밸런서라고 부릅니다. 트래픽을 분배해주는 기능 때문인데 4계층 이상에서 동작하면서 IP주소나 4계층 정보, 애플리케이션 정보를 확인, 수정하는 기능이 있습니다. 

로드 밸런서는 동작하는 계층에 따라 보통 4계층과 7계층으로 나뉩니다.

- L4 로드 밸런싱
  - TCP, UDP 정보(특히 포트 넘버)를 기반으로 로드 밸런싱을 수행합니다. 
- L7 로드 밸런싱
  - HTTP, FTP, SMTP와 같은 프로토콜 정보를 기반으로 로드 밸런싱을 수행합니다. 

### L4 스위치

L4 스위치는 용어 그대로 4계층에서 동작하면서 로드 밸런서 기능이 있는 스위치 입니다. 내부 동작 방식은 4계층 로드 밸런서이지만 외형은 스위치처럼 여러 개의 포트를 가지고 있습니다. 

L4 스위치가 동작하려면 가상 서버, 가상 IP, 리얼 서버와 리얼 IP를 설정해야 합니다. 가상 서버는 사용자가 바라보는 실제 서비스이고 가상 IP는 사용자가 접근해야 하는 서비스 IP 주소입니다. 리얼 서버는 실제 서비스를 수행하는 서버이고 리얼 IP는 실제 서버의 IP 주소입니다. 여기서 L4 스위치는 가상 IP를 리얼 IP로 변경해주는 역할을 합니다.

### ADC

ADC(Application Delivery Controller)는 애플리케이션 계층에서 동작하는 로드 밸런서입니다. 4계층에서 동작하는 L4 스위치와 달리 애플리케이션 프로토콜의 헤더와 내용을 이해하고 동작하므로 다양한 부하 분산, 정보 수정, 정보 필터링이 가능합니다. ADC는 이런 상세한 동작을 위해 프락시로 동작하비다. 

대부분의 ADC는 4계층에서 애플리케이션 계층까지 로드 밸런싱 기능을 제공하고 페일오버(장애극복 기능), 리다이렉션 기능도 함께 수행합니다. 이 외에도 애플리케이션 프로토콜을 이해하고 최적화하는 다양한 기능을 제공합니다. 캐싱, 압축, 콘텐츠 변환 및 재작성, 인코딩 변환 등이 가능하고 애플리케이션 프로토콜 최적화 기능도 제공합니다. 

## 방화벽

네트워크 중간에 위치해 해당 장비를 통과하는 트래픽을 사전에 주어진 정책 조건에 맞추어 허용하거나 차단하는 장비를 방화벽이라고 부릅니다. 

방화벽은 NAT(Network Address Translation) 동작 방식과 유사하게 세션 정보를 장비 내부에 저장합니다. 패킷이 외부로 나갈 때 세션 정보를 저장하고 패킷이 들어오거나 나갈 때 저장했던 세션 정보를 먼저 참조해 들어오는 패킷이 외부에서 처음 시작된 것인지, 내부 사용자가 외부로 요청한 응답인지 가려냅니다.

&nbsp;

Excerpt From <IT 엔지니어를 위한 네트워크 입문> by 고재성, 이상훈